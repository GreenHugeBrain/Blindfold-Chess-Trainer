<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ბლაინდფოლდ ჭადრაკის ტრენერი</title>
  <style>
    body {
      background: linear-gradient(135deg, #1e3c72, #2a5298, #1e3c72);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: rgba(52, 73, 94, 0.95);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    
    h1 {
      color: #ecf0f1;
      margin-bottom: 30px;
      font-size: 32px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .exercise-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }

    .exercise-btn {
      background: linear-gradient(145deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      min-width: 180px;
    }

    .exercise-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .exercise-btn.active {
      background: linear-gradient(145deg, #e74c3c, #c0392b);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .exercise-description {
      background: rgba(44, 62, 80, 0.8);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .board-container {
      position: relative;
      margin: 20px auto;
      width: 400px;
    }
    
    .coordinates {
      position: absolute;
      display: flex;
      font-weight: bold;
      color: #ecf0f1;
      font-size: 14px;
    }
    
    .files {
      bottom: -25px;
      left: 20px;
      width: 400px;
      justify-content: space-around;
    }
    
    .ranks {
      top: 10px;
      left: -25px;
      height: 400px;
      flex-direction: column-reverse;
      justify-content: space-around;
    }
    
    .board {
      width: 400px;
      height: 400px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      margin: 0 auto;
      border: 3px solid #ecf0f1;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      border-radius: 5px;
    }
    
    .square {
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s;
      user-select: none;
      position: relative;
      cursor: pointer;
    }
    
    .light { background-color: #f0d9b5; }
    .dark { background-color: #b58863; }
    
    .square:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    
    .highlighted {
      box-shadow: inset 0 0 0 4px #f39c12;
      animation: pulse 1s infinite;
    }

    .selected {
      box-shadow: inset 0 0 0 4px #e74c3c;
    }

    .possible-move {
      box-shadow: inset 0 0 0 3px #2ecc71;
    }

    .last-move {
      background-color: rgba(241, 196, 15, 0.6) !important;
    }
    
    @keyframes pulse {
      0% { box-shadow: inset 0 0 0 4px #f39c12; }
      50% { box-shadow: inset 0 0 0 6px rgba(243, 156, 18, 0.7); }
      100% { box-shadow: inset 0 0 0 4px #f39c12; }
    }
    
    .piece-img {
      width: 45px;
      height: 45px;
      position: relative;
      z-index: 5;
      transition: transform 0.2s;
    }

    .piece-img:hover {
      transform: scale(1.1);
    }
    
    .controls {
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    button {
      background: linear-gradient(145deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .game-info {
      margin: 20px 0;
      padding: 20px;
      background: rgba(44, 62, 80, 0.8);
      border-radius: 10px;
    }
    
    .stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .stat-box {
      background: rgba(44, 62, 80, 0.9);
      padding: 15px 20px;
      border-radius: 10px;
      text-align: center;
      min-width: 100px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    input, select {
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #bdc3c7;
      width: 200px;
      text-align: center;
      background: white;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3498db;
    }
    
    #question-box {
      padding: 25px;
      background: rgba(44, 62, 80, 0.9);
      border-radius: 10px;
      margin-top: 20px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    #result {
      font-weight: bold;
      margin: 15px 0;
      height: 25px;
      font-size: 18px;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #f39c12;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .level-select {
      margin: 20px 0;
    }
    
    .level-btn {
      background: linear-gradient(145deg, #7f8c8d, #6c7b7d);
      margin: 0 8px;
      padding: 10px 20px;
      box-shadow: 0 4px 15px rgba(127, 140, 157, 0.3);
    }
    
    .level-btn.active {
      background: linear-gradient(145deg, #e74c3c, #c0392b);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(5px);
    }
    
    .popup.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .popup-content {
      background: linear-gradient(145deg, #34495e, #2c3e50);
      padding: 40px;
      border-radius: 15px;
      width: 85%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    
    .progress-bar {
      height: 12px;
      background-color: rgba(44, 62, 80, 0.8);
      border-radius: 6px;
      margin: 20px 0;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, #2ecc71, #27ae60);
      width: 0%;
      transition: width 0.5s;
      border-radius: 6px;
    }

    .pieces-display {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      padding: 25px;
      background: rgba(44, 62, 80, 0.8);
      border-radius: 15px;
    }

    .piece-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(52, 73, 94, 0.9);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s;
    }

    .piece-item:hover {
      transform: translateY(-3px);
    }

    .piece-item img {
      width: 60px;
      height: 60px;
      margin-bottom: 10px;
    }

    .piece-name {
      font-size: 14px;
      color: #ecf0f1;
      text-align: center;
      font-weight: 500;
    }

    .sequence-display {
      background: rgba(44, 62, 80, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      line-height: 1.8;
    }

    .move-notation {
      background: rgba(52, 73, 94, 0.9);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 16px;
    }

    .square-highlight {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(241, 196, 15, 0.8);
      z-index: 3;
    }

    .attack-line {
      position: absolute;
      background: rgba(231, 76, 60, 0.7);
      height: 3px;
      transform-origin: left center;
      z-index: 2;
      border-radius: 2px;
    }
    
    @media (max-width: 600px) {
      .board {
        width: 320px;
        height: 320px;
      }
      
      .square {
        width: 40px;
        height: 40px;
      }
      
      .piece-img {
        width: 35px;
        height: 35px;
      }
      
      .board-container {
        width: 320px;
      }
      
      .files {
        width: 320px;
      }

      .pieces-display {
        gap: 10px;
        padding: 15px;
      }

      .piece-item img {
        width: 50px;
        height: 50px;
      }

      .exercise-selector {
        gap: 8px;
      }

      .exercise-btn {
        min-width: 140px;
        padding: 12px 15px;
        font-size: 12px;
      }

      .stats {
        gap: 10px;
      }

      .stat-box {
        min-width: 80px;
        padding: 10px 15px;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧠 ბლაინდფოლდ ჭადრაკის ტრენერი</h1>
    
    <!-- სვარჯიშოების არჩევა -->
    <div class="exercise-selector">
      <button class="exercise-btn active" data-exercise="memory">🧩 ფიგურების დამახსოვრება</button>
      <button class="exercise-btn" data-exercise="sequence">📝 სვლების მიმდევრობა</button>
      <button class="exercise-btn" data-exercise="position">🎯 პოზიციის ვიზუალიზაცია</button>
      <button class="exercise-btn" data-exercise="moves">♞ შესაძლო სვლები</button>
      <button class="exercise-btn" data-exercise="calculation">🧮 ტაქტიკური კალკულაცია</button>
      <button class="exercise-btn" data-exercise="notation">📋 ნოტაციის ვარჯიში</button>
      <button class="exercise-btn" data-exercise="pattern">🔍 შაბლონების ამოცნობა</button>
    </div>

    <div id="exercise-description" class="exercise-description">
      დაიმახსოვრეთ ყველა ფიგურის პოზიცია და შემდეგ უპასუხეთ შეკითხვებს მეხსიერების მიხედვით.
    </div>
    
    <div class="level-select">
      <span>სირთულე: </span>
      <button class="level-btn active" data-level="easy">მარტივი</button>
      <button class="level-btn" data-level="medium">საშუალო</button>
      <button class="level-btn" data-level="hard">რთული</button>
    </div>
    
    <div class="stats">
      <div class="stat-box">
        <div>დრო</div>
        <div class="timer" id="timer">15</div>
      </div>
      <div class="stat-box">
        <div>ქულა</div>
        <div id="score-display">0</div>
      </div>
      <div class="stat-box">
        <div>შეკითხვები</div>
        <div id="question-counter">0/0</div>
      </div>
      <div class="stat-box">
        <div>სირთულე</div>
        <div id="difficulty-display">მარტივი</div>
      </div>
    </div>
    
    <div class="board-container">
      <div class="coordinates ranks">
        <div>8</div><div>7</div><div>6</div><div>5</div>
        <div>4</div><div>3</div><div>2</div><div>1</div>
      </div>
      <div class="board" id="board"></div>
      <div class="coordinates files">
        <div>a</div><div>b</div><div>c</div><div>d</div>
        <div>e</div><div>f</div><div>g</div><div>h</div>
      </div>
    </div>

    <!-- სხვადასხვა სავარჯიშოების ინტერფეისები -->
    <div id="pieces-display" class="pieces-display" style="display: none;"></div>
    <div id="sequence-display" class="sequence-display" style="display: none;"></div>
    <div id="move-notation" class="move-notation" style="display: none;"></div>
    
    <div id="question-box" style="display:none;">
      <p id="question" style="font-size: 18px; margin-bottom: 15px;"></p>
      <input type="text" id="answer" placeholder="შეიყვანეთ პასუხი">
      <select id="multiple-choice" style="display: none;">
        <option value="">აირჩიეთ პასუხი...</option>
      </select>
      <p id="result"></p>
      <div class="progress-bar">
        <div class="progress" id="progress-bar"></div>
      </div>
    </div>
    
    <div class="controls">
      <button id="start-btn" onclick="startExercise()">სავარჯიშოს დაწყება</button>
      <button id="hint-btn" onclick="showHint()" style="display: none;">💡 მინიშნება</button>
      <button id="next-btn" onclick="nextQuestion()" style="display: none;">შემდეგი</button>
    </div>
  </div>
  
  <div class="popup" id="end-popup">
    <div class="popup-content">
      <h2>სავარჯიშო დასრულებულია! 🎉</h2>
      <p id="final-score"></p>
      <p id="feedback"></p>
      <div id="detailed-stats"></div>
      <button onclick="closePopup()">კარგი</button>
      <button onclick="closePopup(); startExercise();">თავიდან ცდა</button>
    </div>
  </div>

  <script>
    // ძირითადი ცვლადები
    const board = document.getElementById("board");
    const squares = [];
    const timerDisplay = document.getElementById("timer");
    const progressBar = document.getElementById("progress-bar");
    const levelButtons = document.querySelectorAll(".level-btn");
    const exerciseButtons = document.querySelectorAll(".exercise-btn");
    const piecesDisplay = document.getElementById("pieces-display");
    const sequenceDisplay = document.getElementById("sequence-display");
    const moveNotation = document.getElementById("move-notation");
    
    // ჭადრაკის ფიგურების ლინკები
    const pieceImages = {
      white: {
        king: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wk.png",
        queen: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wq.png",
        rook: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wr.png",
        bishop: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wb.png",
        knight: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wn.png",
        pawn: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wp.png"
      },
      black: {
        king: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bk.png",
        queen: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bq.png",
        rook: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/br.png",
        bishop: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bb.png",
        knight: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bn.png",
        pawn: "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bp.png"
      }
    };
    
    // ფიგურების კოდები
    const pieceCodes = {
      white: { king: "wk", queen: "wq", rook: "wr", bishop: "wb", knight: "wn", pawn: "wp" },
      black: { king: "bk", queen: "bq", rook: "br", bishop: "bb", knight: "bn", pawn: "bp" }
    };
    
    // ფიგურების სახელები ქართულად
    const pieceNames = {
      "wk": "თეთრი მეფე", "wq": "თეთრი დედოფალი", "wr": "თეთრი ეტლი", 
      "wb": "თეთრი კუ", "wn": "თეთრი მხედარი", "wp": "თეთრი პაიკი",
      "bk": "შავი მეფე", "bq": "შავი დედოფალი", "br": "შავი ეტლი", 
      "bb": "შავი კუ", "bn": "შავი მხედარი", "bp": "შავი პაიკი"
    };

    // სავარჯიშოების აღწერები
    const exerciseDescriptions = {
      memory: "დაიმახსოვრეთ ყველა ფიგურის პოზიცია და შემდეგ უპასუხეთ შეკითხვებს მეხსიერების მიხედვით.",
      sequence: "დაიმახსოვრეთ სვლების მიმდევრობა და განაგრძეთ ან გაიმეორეთ ის ბლაინდფოლდურად.",
      position: "ვიზუალიზაცია გაუკეთეთ მოცემულ პოზიციას და უპასუხეთ სტრატეგიულ შეკითხვებს.",
      moves: "გამოთვალეთ ყველა შესაძლო სვლა მოცემული ფიგურისთვის კონკრეტულ პოზიციაში.",
      calculation: "გაითვალისწინეთ ტაქტიკური კომბინაციები და იპოვეთ საუკეთესო სვლები.",
      notation: "გადაწერეთ ან ამოიცანით ალგებრული ნოტაცია მოცემული სვლებისთვის.",
      pattern: "ამოიცანით ტიპიური შაბლონები და მოტივები სხვადასხვა პოზიციებში."
    };
    
    // თამაშის მდგომარეობები
    let currentPosition = {};
    let questions = [];
    let currentQuestion = 0;
    let score = 0;
    let memorizationTime = 15;
    let timeRemaining = memorizationTime;
    let timer;
    let gameActive = false;
    let currentDifficulty = "easy";
    let currentExercise = "memory";
    let moveSequence = [];
    let selectedSquare = null;
    let correctAnswers = 0;
    let totalQuestions = 0;
    let startTime = null;

    // დაფის შექმნა
    function createBoard() {
      board.innerHTML = "";
      squares.length = 0;
      for (let r = 8; r >= 1; r--) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement("div");
          const isLight = (r + c) % 2 === 0;
          square.className = `square ${isLight ? "light" : "dark"}`;
          const file = "abcdefgh"[c];
          const id = file + r;
          square.id = id;
          square.onclick = () => handleSquareClick(id);
          board.appendChild(square);
          squares.push(id);
        }
      }
    }

    // უჯრაზე დაჭერის მენეჯმენტი
    function handleSquareClick(squareId) {
      if (!gameActive) return;
      
      const square = document.getElementById(squareId);
      
      if (currentExercise === "moves" && selectedSquare) {
        checkMoveAnswer(selectedSquare, squareId);
      } else if (currentExercise === "position") {
        if (selectedSquare === squareId) {
          square.classList.remove("selected");
          selectedSquare = null;
        } else {
          clearSquareHighlights();
          square.classList.add("selected");
          selectedSquare = squareId;
        }
      }
    }

    // უჯრების ჰაილაითის გასუფთავება
    function clearSquareHighlights() {
      squares.forEach(sq => {
        const square = document.getElementById(sq);
        square.classList.remove("selected", "possible-move", "highlighted", "last-move");
      });
    }
    
    // სირთულის დონეების შექმნა
    function setDifficulty(level) {
      levelButtons.forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.level === level) {
          btn.classList.add("active");
        }
      });
      
      currentDifficulty = level;
      document.getElementById("difficulty-display").textContent = 
        level === "easy" ? "მარტივი" : level === "medium" ? "საშუალო" : "რთული";
      
      // დროის განსხვავება სავარჯიშოების მიხედვით
      const timeSettings = {
        memory: { easy: 20, medium: 15, hard: 10 },
        sequence: { easy: 25, medium: 20, hard: 15 },
        position: { easy: 30, medium: 25, hard: 20 },
        moves: { easy: 15, medium: 12, hard: 10 },
        calculation: { easy: 30, medium: 25, hard: 20 },
        notation: { easy: 20, medium: 15, hard: 12 },
        pattern: { easy: 25, medium: 20, hard: 15 }
      };
      
      memorizationTime = timeSettings[currentExercise][level];
      timerDisplay.textContent = memorizationTime;
    }

    // სავარჯიშოს არჩევა
    function selectExercise(exercise) {
      exerciseButtons.forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.exercise === exercise) {
          btn.classList.add("active");
        }
      });
      
      currentExercise = exercise;
      document.getElementById("exercise-description").textContent = exerciseDescriptions[exercise];
      
      // დროის განახლება
      setDifficulty(currentDifficulty);
      
      // ინტერფეისის განახლება
      hideAllDisplays();
      clearBoard();
    }

    // ყველა დისპლეის დამალვა
    function hideAllDisplays() {
      piecesDisplay.style.display = "none";
      sequenceDisplay.style.display = "none";
      moveNotation.style.display = "none";
      document.getElementById("question-box").style.display = "none";
      document.getElementById("multiple-choice").style.display = "none";
      document.getElementById("answer").style.display = "inline";
      document.getElementById("hint-btn").style.display = "none";
      document.getElementById("next-btn").style.display = "none";
    }

    // დაფის გასუფთავება
    function clearBoard() {
      squares.forEach(sq => {
        const square = document.getElementById(sq);
        square.innerHTML = "";
        square.classList.remove("selected", "possible-move", "highlighted", "last-move");
      });
      currentPosition = {};
      selectedSquare = null;
    }
    
    // ფიგურის გამოსახულების დამატება დაფაზე
    function addPieceToSquare(squareId, pieceCode) {
      const square = document.getElementById(squareId);
      square.innerHTML = "";
      
      let color, pieceName;
      if (pieceCode[0] === 'w') {
        color = 'white';
        pieceName = pieceCode.substring(1);
      } else {
        color = 'black';
        pieceName = pieceCode.substring(1);
      }
      
      const pieceNameLookup = {
        'k': 'king', 'q': 'queen', 'r': 'rook', 
        'b': 'bishop', 'n': 'knight', 'p': 'pawn'
      };
      
      const pieceType = pieceNameLookup[pieceName];
      const imageUrl = pieceImages[color][pieceType];
      
      const pieceImg = document.createElement("img");
      pieceImg.src = imageUrl;
      pieceImg.className = "piece-img";
      pieceImg.alt = pieceNames[pieceCode];
      pieceImg.draggable = false;
      
      square.appendChild(pieceImg);
    }

    // ===== სავარჯიშო 1: ფიგურების დამახსოვრება =====
    function setupMemoryExercise() {
      clearBoard();
      placeRandomPieces();
    }

    function placeRandomPieces() {
      currentPosition = {};
      const usedSquares = [];
      
      let numPieces;
      switch (currentDifficulty) {
        case "easy": numPieces = 6; break;
        case "medium": numPieces = 9; break;
        case "hard": numPieces = 12; break;
        default: numPieces = 6;
      }
      
      const allPieceCodes = [
        ...Object.values(pieceCodes.white),
        ...Object.values(pieceCodes.black)
      ];
      
      const selectedPieces = [];
      const usedPieceCodes = new Set();
      
      while (selectedPieces.length < numPieces && selectedPieces.length < allPieceCodes.length) {
        const randomPieceCode = allPieceCodes[Math.floor(Math.random() * allPieceCodes.length)];
        if (!usedPieceCodes.has(randomPieceCode)) {
          selectedPieces.push(randomPieceCode);
          usedPieceCodes.add(randomPieceCode);
        }
      }
      
      for (let i = 0; i < selectedPieces.length; i++) {
        let sq;
        do {
          sq = squares[Math.floor(Math.random() * squares.length)];
        } while (usedSquares.includes(sq));
        usedSquares.push(sq);
        
        const pieceCode = selectedPieces[i];
        currentPosition[sq] = pieceCode;
        addPieceToSquare(sq, pieceCode);
      }
    }

    function generateMemoryQuestions() {
      questions = [];
      const positions = Object.entries(currentPosition);
      
      // სად იდგა ფიგურა
      for (let [sq, pieceCode] of positions) {
        questions.push({
          type: "piece_location",
          piece: pieceCode,
          answer: sq,
          text: `სად იდგა ${pieceNames[pieceCode]}?`
        });
      }
      
      // რა იდგა კონკრეტულ უჯრაზე
      for (let [sq, pieceCode] of positions) {
        questions.push({
          type: "square_piece",
          square: sq,
          answer: pieceNames[pieceCode],
          text: `რა ფიგურა იდგა ${sq} უჯრაზე?`
        });
      }
      
      shuffleArray(questions);
      questions = questions.slice(0, Math.min(8, questions.length));
    }

    // ===== სავარჯიშო 2: სვლების მიმდევრობა =====
    function setupSequenceExercise() {
      clearBoard();
      setupInitialPosition();
      generateMoveSequence();
      displayMoveSequence();
    }

    function setupInitialPosition() {
      // სტანდარტული დაწყებითი პოზიცია (გამარტივებული)
      const initialPieces = {
        "a1": "wr", "b1": "wn", "c1": "wb", "d1": "wq", "e1": "wk", "f1": "wb", "g1": "wn", "h1": "wr",
        "a2": "wp", "b2": "wp", "c2": "wp", "d2": "wp", "e2": "wp", "f2": "wp", "g2": "wp", "h2": "wp",
        "a8": "br", "b8": "bn", "c8": "bb", "d8": "bq", "e8": "bk", "f8": "bb", "g8": "bn", "h8": "br",
        "a7": "bp", "b7": "bp", "c7": "bp", "d7": "bp", "e7": "bp", "f7": "bp", "g7": "bp", "h7": "bp"
      };

      currentPosition = { ...initialPieces };
      
      // მხოლოდ რამდენიმე ფიგური მარტივი ვარიანტისთვის
      if (currentDifficulty === "easy") {
        currentPosition = {
          "e1": "wk", "d1": "wq", "a1": "wr", "h1": "wr",
          "e2": "wp", "d2": "wp", "f2": "wp", "g2": "wp",
          "e8": "bk", "d8": "bq", "a8": "br", "h8": "br",
          "e7": "bp", "d7": "bp", "f7": "bp", "g7": "bp"
        };
      }

      for (let [sq, piece] of Object.entries(currentPosition)) {
        addPieceToSquare(sq, piece);
      }
    }

    function generateMoveSequence() {
      moveSequence = [];
      const numMoves = currentDifficulty === "easy" ? 3 : currentDifficulty === "medium" ? 5 : 7;
      
      // გამარტივებული სვლების გენერაცია
      const sampleMoves = [
        { from: "e2", to: "e4", notation: "e4" },
        { from: "e7", to: "e5", notation: "e5" },
        { from: "g1", to: "f3", notation: "Nf3" },
        { from: "b8", to: "c6", notation: "Nc6" },
        { from: "f1", to: "c4", notation: "Bc4" },
        { from: "f8", to: "c5", notation: "Bc5" },
        { from: "d2", to: "d3", notation: "d3" }
      ];

      for (let i = 0; i < Math.min(numMoves, sampleMoves.length); i++) {
        moveSequence.push(sampleMoves[i]);
      }
    }

    function displayMoveSequence() {
      let moveText = "სვლების მიმდევრობა:\n\n";
      moveSequence.forEach((move, index) => {
        const moveNum = Math.floor(index / 2) + 1;
        const isWhite = index % 2 === 0;
        if (isWhite) {
          moveText += `${moveNum}. ${move.notation} `;
        } else {
          moveText += `${move.notation}\n`;
        }
      });
      
      sequenceDisplay.textContent = moveText;
      sequenceDisplay.style.display = "block";
    }

    function generateSequenceQuestions() {
      questions = [];
      
      // შეკითხვები სვლების შესახებ
      moveSequence.forEach((move, index) => {
        questions.push({
          type: "move_notation",
          moveIndex: index,
          answer: move.notation,
          text: `რა იყო ${index + 1}-ე სვლის ნოტაცია?`
        });
        
        questions.push({
          type: "move_from",
          moveIndex: index,
          answer: move.from,
          text: `საიდან გადავიდა ფიგურა ${index + 1}-ე სვლაში?`
        });
      });

      shuffleArray(questions);
      questions = questions.slice(0, Math.min(6, questions.length));
    }

    // ===== სავარჯიშო 3: პოზიციის ვიზუალიზაცია =====
    function setupPositionExercise() {
      clearBoard();
      createStrategicPosition();
    }

    function createStrategicPosition() {
      // შუა თამაშის პოზიცია
      const strategicPositions = [
        {
          "e1": "wk", "d1": "wq", "a1": "wr", "f1": "wr", "c1": "wb", "g1": "wn",
          "a2": "wp", "b2": "wp", "f2": "wp", "g2": "wp", "h2": "wp",
          "d4": "wp", "e4": "wp", "f4": "wn",
          "e8": "bk", "d8": "bq", "a8": "br", "h8": "br", "f8": "bb",
          "a7": "bp", "b7": "bp", "f7": "bp", "g7": "bp", "h7": "bp",
          "d5": "bp", "e5": "bp", "c6": "bn"
        },
        {
          "g1": "wk", "d1": "wq", "a1": "wr", "f1": "wr", "c1": "wb", "b1": "wn",
          "a2": "wp", "f2": "wp", "g2": "wp", "h2": "wp",
          "d4": "wp", "e4": "wp", "c4": "wb",
          "g8": "bk", "d8": "bq", "a8": "br", "h8": "br", "c8": "bb",
          "a7": "bp", "b7": "bp", "f7": "bp", "g7": "bp", "h7": "bp",
          "d5": "bp", "e6": "bp", "f6": "bn"
        }
      ];

      const randomPosition = strategicPositions[Math.floor(Math.random() * strategicPositions.length)];
      currentPosition = { ...randomPosition };

      for (let [sq, piece] of Object.entries(currentPosition)) {
        addPieceToSquare(sq, piece);
      }
    }

    function generatePositionQuestions() {
      questions = [];
      
      // სტრატეგიული შეკითხვები
      questions.push({
        type: "strategy",
        answer: "center",
        options: ["center", "kingside", "queenside", "endgame"],
        text: "რომელ სექტორში აქვს თეთრს უპირატესობა?"
      });

      questions.push({
        type: "piece_count",
        answer: Object.keys(currentPosition).length.toString(),
        text: "ჯამში რამდენი ფიგურა დგას დაფაზე?"
      });

      questions.push({
        type: "king_safety",
        answer: "safe",
        options: ["safe", "danger", "castled", "exposed"],
        text: "რა მდგომარეობაშია თეთრი მეფე?"
      });
    }

    // ===== სავარჯიშო 4: შესაძლო სვლები =====
    function setupMovesExercise() {
      clearBoard();
      placeRandomPieces();
      
      // აირჩიეთ ერთი ფიგურა შესაძლო სვლების საჩვენებლად
      const pieces = Object.entries(currentPosition);
      const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
      selectedSquare = randomPiece[0];
      
      document.getElementById(selectedSquare).classList.add("highlighted");
    }

    function generateMovesQuestions() {
      questions = [];
      const possibleMoves = calculatePossibleMoves(selectedSquare, currentPosition[selectedSquare]);
      
      questions.push({
        type: "possible_moves",
        piece: currentPosition[selectedSquare],
        square: selectedSquare,
        answer: possibleMoves,
        text: `რამდენი შესაძლო სვლა აქვს ${pieceNames[currentPosition[selectedSquare]]} ფიგურას ${selectedSquare} უჯრიდან?`
      });

      // კონკრეტული სვლები
      possibleMoves.forEach(move => {
        questions.push({
          type: "is_valid_move",
          from: selectedSquare,
          to: move,
          answer: "yes",
          text: `შესაძლებელია თუ არა სვლა ${selectedSquare}-დან ${move}-ზე?`
        });
      });

      // არასწორი სვლები
      const invalidMoves = getInvalidMoves(selectedSquare, possibleMoves);
      invalidMoves.slice(0, 2).forEach(move => {
        questions.push({
          type: "is_valid_move",
          from: selectedSquare,
          to: move,
          answer: "no",
          text: `შესაძლებელია თუ არა სვლა ${selectedSquare}-დან ${move}-ზე?`
        });
      });

      shuffleArray(questions);
      questions = questions.slice(0, 6);
    }

    function calculatePossibleMoves(square, piece) {
      const moves = [];
      const file = square[0];
      const rank = parseInt(square[1]);
      const fileIndex = file.charCodeAt(0) - 97; // a=0, b=1, etc.
      
      const pieceType = piece[1];
      
      switch (pieceType) {
        case 'p': // პაიკი
          const direction = piece[0] === 'w' ? 1 : -1;
          const newRank = rank + direction;
          if (newRank >= 1 && newRank <= 8) {
            const newSquare = file + newRank;
            if (!currentPosition[newSquare]) {
              moves.push(newSquare);
            }
          }
          break;
          
        case 'r': // ეტლი
          // ჰორიზონტალური და ვერტიკალური სვლები
          for (let i = 0; i < 8; i++) {
            if (i !== fileIndex) {
              const newSquare = String.fromCharCode(97 + i) + rank;
              if (!currentPosition[newSquare] || currentPosition[newSquare][0] !== piece[0]) {
                moves.push(newSquare);
              }
            }
            if (i + 1 !== rank) {
              const newSquare = file + (i + 1);
              if (!currentPosition[newSquare] || currentPosition[newSquare][0] !== piece[0]) {
                moves.push(newSquare);
              }
            }
          }
          break;
          
        case 'n': // მხედარი
          const knightMoves = [
            [-2, -1], [-2, 1], [-1, -2], [-1, 2],
            [1, -2], [1, 2], [2, -1], [2, 1]
          ];
          knightMoves.forEach(([df, dr]) => {
            const newFile = fileIndex + df;
            const newRank = rank + dr;
            if (newFile >= 0 && newFile < 8 && newRank >= 1 && newRank <= 8) {
              const newSquare = String.fromCharCode(97 + newFile) + newRank;
              if (!currentPosition[newSquare] || currentPosition[newSquare][0] !== piece[0]) {
                moves.push(newSquare);
              }
            }
          });
          break;
          
        case 'b': // კუ
          // დიაგონალური სვლები
          for (let i = 1; i < 8; i++) {
            const directions = [[1, 1], [1, -1], [-1, 1], [-1, -1]];
            directions.forEach(([df, dr]) => {
              const newFile = fileIndex + df * i;
              const newRank = rank + dr * i;
              if (newFile >= 0 && newFile < 8 && newRank >= 1 && newRank <= 8) {
                const newSquare = String.fromCharCode(97 + newFile) + newRank;
                if (!currentPosition[newSquare]) {
                  moves.push(newSquare);
                } else if (currentPosition[newSquare][0] !== piece[0]) {
                  moves.push(newSquare);
                }
              }
            });
          }
          break;
          
        case 'q': // დედოფალი
          // ეტლისა და კუს კომბინაცია
          for (let i = 1; i < 8; i++) {
            const directions = [[1, 0], [-1, 0], [0, 1], [0, -1], [1, 1], [1, -1], [-1, 1], [-1, -1]];
            directions.forEach(([df, dr]) => {
              const newFile = fileIndex + df * i;
              const newRank = rank + dr * i;
              if (newFile >= 0 && newFile < 8 && newRank >= 1 && newRank <= 8) {
                const newSquare = String.fromCharCode(97 + newFile) + newRank;
                if (!currentPosition[newSquare]) {
                  moves.push(newSquare);
                } else if (currentPosition[newSquare][0] !== piece[0]) {
                  moves.push(newSquare);
                }
              }
            });
          }
          break;
          
        case 'k': // მეფე
          const kingMoves = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1], [0, 1],
            [1, -1], [1, 0], [1, 1]
          ];
          kingMoves.forEach(([df, dr]) => {
            const newFile = fileIndex + df;
            const newRank = rank + dr;
            if (newFile >= 0 && newFile < 8 && newRank >= 1 && newRank <= 8) {
              const newSquare = String.fromCharCode(97 + newFile) + newRank;
              if (!currentPosition[newSquare] || currentPosition[newSquare][0] !== piece[0]) {
                moves.push(newSquare);
              }
            }
          });
          break;
      }
      
      return moves.filter((move, index) => moves.indexOf(move) === index); // უნიკალური სვლები
    }

    function getInvalidMoves(square, validMoves) {
      const allSquares = squares.filter(sq => sq !== square && !validMoves.includes(sq));
      return shuffleArray([...allSquares]).slice(0, 5);
    }

    function checkMoveAnswer(from, to) {
      const possibleMoves = calculatePossibleMoves(from, currentPosition[from]);
      const isValid = possibleMoves.includes(to);
      
      const resultEl = document.getElementById("result");
      if (isValid) {
        score++;
        document.getElementById("score-display").textContent = score;
        resultEl.textContent = "✓ სწორია! ეს სვლა ვალიდურია.";
        resultEl.style.color = "#2ecc71";
        document.getElementById(to).classList.add("possible-move");
      } else {
        resultEl.textContent = "✗ არასწორია! ეს სვლა არ არის ვალიდური.";
        resultEl.style.color = "#e74c3c";
      }
      
      setTimeout(() => {
        clearSquareHighlights();
        nextQuestion();
      }, 2000);
    }

    // ===== სავარჯიშო 5: ტაქტიკური კალკულაცია =====
    function setupCalculationExercise() {
      clearBoard();
      createTacticalPosition();
    }

    function createTacticalPosition() {
      // ტაქტიკური პოზიციები
      const tacticalPositions = [
        {
          // კუ+ეტლი ატაკა
          "g1": "wk", "d1": "wq", "a1": "wr", "c1": "wb",
          "f2": "wp", "g2": "wp", "h2": "wp", "e4": "wp",
          "g8": "bk", "h8": "br", "f8": "bb", "g7": "bp", "h7": "bp", "f7": "bp"
        },
        {
          // ღია ხაზები
          "e1": "wk", "d1": "wq", "a1": "wr", "h1": "wr",
          "a2": "wp", "b2": "wp", "f2": "wp", "g2": "wp", "h2": "wp",
          "e4": "wp", "d4": "wn",
          "e8": "bk", "d8": "bq", "a8": "br", "h8": "br",
          "a7": "bp", "b7": "bp", "f7": "bp", "g7": "bp", "h7": "bp", "e5": "bp"
        }
      ];

      const randomPosition = tacticalPositions[Math.floor(Math.random() * tacticalPositions.length)];
      currentPosition = { ...randomPosition };

      for (let [sq, piece] of Object.entries(currentPosition)) {
        addPieceToSquare(sq, piece);
      }
    }

    function generateCalculationQuestions() {
      questions = [];
      
      questions.push({
        type: "tactics",
        answer: "attack",
        options: ["attack", "defend", "develop", "castle"],
        text: "რა უნდა იყოს თეთრის მთავარი სტრატეგია ამ პოზიციაში?"
      });

      questions.push({
        type: "threat",
        answer: "yes",
        options: ["yes", "no"],
        text: "არის თუ არა შავი მეფე საფრთხეში?"
      });

      questions.push({
        type: "best_move",
        answer: "Qh5",
        text: "რა არის საუკეთესო სვლა თეთრისთვის? (ალგებრული ნოტაცია)"
      });
    }

    // ===== სავარჯიშო 6: ნოტაციის ვარჯიში =====
    function setupNotationExercise() {
      clearBoard();
      setupInitialPosition();
      displayRandomMoves();
    }

    function displayRandomMoves() {
      const sampleMoves = [
        { move: "e2-e4", notation: "e4" },
        { move: "Ng1-f3", notation: "Nf3" },
        { move: "Bf1-c4", notation: "Bc4" },
        { move: "Qd1-h5", notation: "Qh5" },
        { move: "O-O", notation: "O-O" }
      ];

      let moveText = "გადაწერეთ ალგებრული ნოტაციით:\n\n";
      moveSequence = sampleMoves.slice(0, currentDifficulty === "easy" ? 3 : currentDifficulty === "medium" ? 4 : 5);
      
      moveSequence.forEach((move, index) => {
        moveText += `${index + 1}. ${move.move}\n`;
      });
      
      moveNotation.textContent = moveText;
      moveNotation.style.display = "block";
    }

    function generateNotationQuestions() {
      questions = [];
      
      moveSequence.forEach((move, index) => {
        questions.push({
          type: "notation_convert",
          answer: move.notation,
          text: `როგორ იწერება "${move.move}" ალგებრული ნოტაციით?`
        });
      });
    }

    // ===== სავარჯიშო 7: შაბლონების ამოცნობა =====
    function setupPatternExercise() {
      clearBoard();
      createPatternPosition();
    }

    function createPatternPosition() {
      // ტიპიური შაბლონები
      const patterns = [
        {
          // Back rank mate pattern
          "a1": "br", "b1": "br", "e1": "wk",
          "a2": "wp", "b2": "wp", "g2": "wp", "h2": "wp",
          name: "Back Rank Mate"
        },
        {
          // Smothered mate pattern
          "g8": "bk", "h8": "br", "f7": "bp", "g7": "bp", "h7": "bp",
          "f6": "wn", "e7": "wq",
          name: "Smothered Mate"
        },
        {
          // Pin pattern
          "e1": "wk", "e8": "bq", "e4": "wr",
          "d1": "wq", "f1": "wb",
          name: "Pin"
        }
      ];

      const randomPattern = patterns[Math.floor(Math.random() * patterns.length)];
      currentPosition = { ...randomPattern };
      delete currentPosition.name;

      for (let [sq, piece] of Object.entries(currentPosition)) {
        addPieceToSquare(sq, piece);
      }
    }

    function generatePatternQuestions() {
      questions = [];
      
      questions.push({
        type: "pattern_name",
        answer: "mate",
        options: ["mate", "pin", "fork", "skewer"],
        text: "რა სახის ტაქტიკური მოტივია ეს?"
      });

      questions.push({
        type: "pattern_solution",
        answer: "checkmate",
        options: ["checkmate", "material", "position", "tempo"],
        text: "რა არის ამ პოზიციის მთავარი იდეა?"
      });
    }

    // ===== ზოგადი ფუნქციები =====

    // შეკითხვების ჩვენება
    function showQuestion() {
      if (currentQuestion >= questions.length) {
        endExercise();
        return;
      }
      
      const q = questions[currentQuestion];
      document.getElementById("result").textContent = "";
      document.getElementById("question").textContent = q.text;
      document.getElementById("question-counter").textContent = `${currentQuestion + 1}/${questions.length}`;
      
      // მულტი-ჩოის ან ტექსტის შეყვანა
      if (q.options) {
        document.getElementById("answer").style.display = "none";
        const select = document.getElementById("multiple-choice");
        select.style.display = "inline";
        select.innerHTML = '<option value="">აირჩიეთ პასუხი...</option>';
        q.options.forEach(option => {
          const optionEl = document.createElement("option");
          optionEl.value = option;
          optionEl.textContent = option;
          select.appendChild(optionEl);
        });
        select.focus();
      } else {
        document.getElementById("multiple-choice").style.display = "none";
        document.getElementById("answer").style.display = "inline";
        document.getElementById("answer").value = "";
        document.getElementById("answer").focus();
      }
      
      const progress = ((currentQuestion) / questions.length) * 100;
      progressBar.style.width = `${progress}%`;
    }

    // პასუხის შემოწმება
    function submitAnswer() {
      if (!gameActive) return;
      
      let userAnswer;
      const q = questions[currentQuestion];
      
      if (q.options) {
        userAnswer = document.getElementById("multiple-choice").value;
      } else {
        userAnswer = document.getElementById("answer").value.trim().toLowerCase();
      }
      
      if (!userAnswer) return;
      
      let isCorrect = false;
      
      if (q.type === "possible_moves") {
        const numMoves = parseInt(userAnswer);
        isCorrect = numMoves === q.answer.length;
      } else if (Array.isArray(q.answer)) {
        isCorrect = q.answer.includes(userAnswer.toLowerCase());
      } else {
        isCorrect = userAnswer.toLowerCase() === q.answer.toLowerCase();
      }
      
      const resultEl = document.getElementById("result");
      
      if (isCorrect) {
        correctAnswers++;
        score++;
        document.getElementById("score-display").textContent = score;
        resultEl.textContent = "✓ სწორია!";
        resultEl.style.color = "#2ecc71";
      } else {
        let correctAnswer = Array.isArray(q.answer) ? q.answer[0] : q.answer;
        if (q.type === "possible_moves") {
          correctAnswer = q.answer.length.toString();
        }
        resultEl.textContent = `✗ არასწორია. სწორი პასუხი: ${correctAnswer}`;
        resultEl.style.color = "#e74c3c";
      }
      
      totalQuestions++;
      currentQuestion++;
      
      if (currentExercise === "moves") {
        document.getElementById("next-btn").style.display = "inline";
      } else {
        setTimeout(showQuestion, 2000);
      }
    }

    function nextQuestion() {
      document.getElementById("next-btn").style.display = "none";
      showQuestion();
    }

    function showHint() {
      const q = questions[currentQuestion];
      let hint = "";
      
      switch (q.type) {
        case "piece_location":
          hint = `ეს ფიგურა იდგა ვერტიკალ ${q.answer[0]} უჯრაზე`;
          break;
        case "square_piece":
          hint = `ეს იყო ${q.answer.includes("თეთრი") ? "თეთრი" : "შავი"} ფიგურა`;
          break;
        case "possible_moves":
          hint = `ამ ფიგურას შეუძლია ${Math.floor(q.answer.length/2)}-${q.answer.length} სვლა`;
          break;
        default:
          hint = "დაფიქრდით კარგად პოზიციაზე...";
          break;
      }
      
      alert("💡 მინიშნება: " + hint);
    }

    // მასივის არევა
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // ფიგურების დამალვა და ჩვენება სიაში
    function hidePiecesAndShowList() {
      squares.forEach(sq => {
        document.getElementById(sq).innerHTML = "";
      });
      
      if (currentExercise === "memory") {
        piecesDisplay.innerHTML = "";
        const pieces = Object.entries(currentPosition);
        
        pieces.forEach(([square, pieceCode]) => {
          const pieceItem = document.createElement("div");
          pieceItem.className = "piece-item";
          
          let color, pieceName;
          if (pieceCode[0] === 'w') {
            color = 'white';
            pieceName = pieceCode.substring(1);
          } else {
            color = 'black';
            pieceName = pieceCode.substring(1);
          }
          
          const pieceNameLookup = {
            'k': 'king', 'q': 'queen', 'r': 'rook', 
            'b': 'bishop', 'n': 'knight', 'p': 'pawn'
          };
          
          const pieceType = pieceNameLookup[pieceName];
          const imageUrl = pieceImages[color][pieceType];
          
          pieceItem.innerHTML = `
            <img src="${imageUrl}" alt="${pieceNames[pieceCode]}">
            <div class="piece-name">${pieceNames[pieceCode]}</div>
          `;
          
          piecesDisplay.appendChild(pieceItem);
        });
        
        piecesDisplay.style.display = "flex";
      }
    }

    // დასამახსოვრებელი დროის ტაიმერი
    function startMemorizationTimer() {
      timeRemaining = memorizationTime;
      timerDisplay.textContent = timeRemaining;
      
      timer = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = timeRemaining;
        
        // ბოლო 5 წამი - გაფრთხილება
        if (timeRemaining <= 5 && timeRemaining > 0) {
          timerDisplay.style.color = "#e74c3c";
          timerDisplay.style.animation = "pulse 0.5s infinite";
        }
        
        if (timeRemaining <= 0) {
          clearInterval(timer);
          timerDisplay.style.color = "#f39c12";
          timerDisplay.style.animation = "none";
          
          // სავარჯიშოს გაგრძელება
          if (currentExercise === "memory") {
            hidePiecesAndShowList();
          } else {
            clearBoard();
          }
          
          document.getElementById("question-box").style.display = "block";
          showQuestion();
        }
      }, 1000);
    }

    // სავარჯიშოს დაწყება
    function startExercise() {
      hideAllDisplays();
      document.getElementById("start-btn").disabled = true;
      document.getElementById("hint-btn").style.display = "inline";
      progressBar.style.width = "0%";
      
      score = 0;
      correctAnswers = 0;
      totalQuestions = 0;
      document.getElementById("score-display").textContent = score;
      currentQuestion = 0;
      gameActive = true;
      selectedSquare = null;
      startTime = Date.now();
      
      // სავარჯიშოს მიხედვით setup
      switch (currentExercise) {
        case "memory":
          setupMemoryExercise();
          generateMemoryQuestions();
          break;
        case "sequence":
          setupSequenceExercise();
          generateSequenceQuestions();
          break;
        case "position":
          setupPositionExercise();
          generatePositionQuestions();
          break;
        case "moves":
          setupMovesExercise();
          generateMovesQuestions();
          break;
        case "calculation":
          setupCalculationExercise();
          generateCalculationQuestions();
          break;
        case "notation":
          setupNotationExercise();
          generateNotationQuestions();
          break;
        case "pattern":
          setupPatternExercise();
          generatePatternQuestions();
          break;
      }
      
      startMemorizationTimer();
    }

    // სავარჯიშოს დასრულება
    function endExercise() {
      gameActive = false;
      clearInterval(timer);
      document.getElementById("start-btn").disabled = false;
      document.getElementById("question-box").style.display = "none";
      document.getElementById("hint-btn").style.display = "none";
      document.getElementById("next-btn").style.display = "none";
      hideAllDisplays();
      
      const endTime = Date.now();
      const totalTime = Math.round((endTime - startTime) / 1000);
      const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
      
      const finalScore = document.getElementById("final-score");
      const feedback = document.getElementById("feedback");
      const detailedStats = document.getElementById("detailed-stats");
      
      finalScore.textContent = `ქულა: ${score} / ${questions.length} (${accuracy}%)`;
      
      // დეტალური სტატისტიკა
      detailedStats.innerHTML = `
        <div style="margin: 20px 0; padding: 15px; background: rgba(44, 62, 80, 0.8); border-radius: 10px;">
          <h3>დეტალური შედეგები:</h3>
          <p>სავარჯიშო: ${getExerciseName(currentExercise)}</p>
          <p>სირთულე: ${getCurrentDifficultyName()}</p>
          <p>სიზუსტე: ${accuracy}%</p>
          <p>დრო: ${totalTime} წამი</p>
          <p>საშუალო დრო ერთ შეკითხვაზე: ${Math.round(totalTime / questions.length)} წამი</p>
        </div>
      `;
      
      if (accuracy >= 90) {
        feedback.textContent = "🏆 შესანიშნავია! თქვენ გაქვთ საოცარი მეხსიერება და ვიზუალიზაციის უნარი!";
      } else if (accuracy >= 75) {
        feedback.textContent = "🥇 ძალიან კარგი! თქვენ კარგად ალაგებთ ბლაინდფოლდ ჭადრაკს!";
      } else if (accuracy >= 60) {
        feedback.textContent = "🥈 კარგი შედეგია! კიდევ ცოტა ვარჯიში და შესანიშნავი იქნება!";
      } else if (accuracy >= 40) {
        feedback.textContent = "🥉 არ შეცდომდეთ, ყველას სჭირდება ვარჯიში. განაგრძეთ!";
      } else {
        feedback.textContent = "💪 კიდევ სცადეთ! ვარჯიშით ნამდვილად გააუმჯობესებთ შედეგებს!";
      }
      
      document.getElementById("end-popup").classList.add("active");
    }

    function getExerciseName(exercise) {
      const names = {
        memory: "ფიგურების დამახსოვრება",
        sequence: "სვლების მიმდევრობა", 
        position: "პოზიციის ვიზუალიზაცია",
        moves: "შესაძლო სვლები",
        calculation: "ტაქტიკური კალკულაცია",
        notation: "ნოტაციის ვარჯიში",
        pattern: "შაბლონების ამოცნობა"
      };
      return names[exercise] || exercise;
    }

    function getCurrentDifficultyName() {
      return currentDifficulty === "easy" ? "მარტივი" : 
             currentDifficulty === "medium" ? "საშუალო" : "რთული";
    }

    // დიალოგის დახურვა
    function closePopup() {
      document.getElementById("end-popup").classList.remove("active");
    }

    // Event Listeners
    document.getElementById("answer").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        submitAnswer();
      }
    });

    document.getElementById("multiple-choice").addEventListener("change", function() {
      if (this.value) {
        submitAnswer();
      }
    });

    // სირთულის დონის არჩევა
    levelButtons.forEach(btn => {
      btn.addEventListener("click", function() {
        if (!gameActive) {
          setDifficulty(this.dataset.level);
        }
      });
    });

    // სავარჯიშოს არჩევა
    exerciseButtons.forEach(btn => {
      btn.addEventListener("click", function() {
        if (!gameActive) {
          selectExercise(this.dataset.exercise);
        }
      });
    });

    // იმიჯების პრელოადი
    function preloadImages() {
      const imagePromises = [];
      
      for (const color in pieceImages) {
        for (const piece in pieceImages[color]) {
          const img = new Image();
          img.src = pieceImages[color][piece];
          imagePromises.push(new Promise((resolve) => {
            img.onload = resolve;
            img.onerror = resolve; // არ ვაჩერებთ ერორების გამო
          }));
        }
      }
      
      return Promise.all(imagePromises);
    }

    // კლავიატურის მხარდაჭერა
    document.addEventListener("keydown", function(event) {
      if (!gameActive) return;
      
      // მინიშნება - H ღილაკით
      if (event.key.toLowerCase() === 'h' && document.getElementById("hint-btn").style.display !== "none") {
        showHint();
      }
      
      // შემდეგი შეკითხვა - N ღილაკით
      if (event.key.toLowerCase() === 'n' && document.getElementById("next-btn").style.display !== "none") {
        nextQuestion();
      }
    });

    // თამაშის ინიციალიზაცია
    createBoard();
    setDifficulty("easy");
    selectExercise("memory");
    
    preloadImages().then(() => {
      document.getElementById("start-btn").disabled = false;
      console.log("ყველა ფიგურის სურათი ჩაიტვირთა ✓");
    }).catch(() => {
      document.getElementById("start-btn").disabled = false;
      console.log("ზოგიერთი სურათის ჩატვირთვა ვერ მოხერხდა, მაგრამ თამაში მუშაობს");
    });

    // დამატებითი CSS ანიმაციები
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { transform: translateX(-100%); }
        to { transform: translateX(0); }
      }
      
      .question-box {
        animation: fadeIn 0.5s ease-out;
      }
      
      .popup-content {
        animation: fadeIn 0.3s ease-out;
      }
      
      .piece-item {
        animation: fadeIn 0.3s ease-out;
      }
      
      .progress {
        animation: slideIn 0.5s ease-out;
      }
    `;
    document.head.appendChild(style);

    console.log("🧠 ბლაინდფოლდ ჭადრაკის ტრენერი მზადაა!");
    console.log("🎮 7 სხვადასხვა სავარჯიშო:");
    console.log("   1. ფიგურების დამახსოვრება");
    console.log("   2. სვლების მიმდევრობა");  
    console.log("   3. პოზიციის ვიზუალიზაცია");
    console.log("   4. შესაძლო სვლები");
    console.log("   5. ტაქტიკური კალკულაცია");
    console.log("   6. ნოტაციის ვარჯიში");
    console.log("   7. შაბლონების ამოცნობა");
    console.log("⌨️  მინიშნება: H, შემდეგი: N");
  </script>
</body>
</html>
